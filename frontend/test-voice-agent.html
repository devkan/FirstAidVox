<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Agent Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-result {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        #messageInput {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            border: 1px solid #ccc;
            border-radius: 5px;
        }
    </style>
</head>
<body>
    <h1>FirstAidVox Voice Agent Test</h1>
    <div class="info test-result">
        <strong>Test Purpose:</strong> Verify that the infinite rendering loop issue has been fixed and the voice agent works correctly.
    </div>

    <div id="testResults"></div>

    <h2>Manual Test</h2>
    <p>Use the controls below to test the voice agent functionality:</p>
    
    <div>
        <button id="startVoiceBtn">Start Voice Agent</button>
        <button id="stopVoiceBtn" disabled>Stop Voice Agent</button>
        <button id="clearQueueBtn">Clear Queue</button>
    </div>

    <div>
        <input type="text" id="messageInput" placeholder="Type a test message here..." />
        <button id="sendMessageBtn">Send Message</button>
    </div>

    <div id="status" class="info test-result">
        <strong>Status:</strong> <span id="statusText">Ready</span>
    </div>

    <div id="logs" style="background-color: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 20px; max-height: 300px; overflow-y: auto;">
        <h3>Console Logs:</h3>
        <div id="logContent"></div>
    </div>

    <script type="module">
        // Simple test to verify the voice agent doesn't cause infinite loops
        let testResults = [];
        let logCount = 0;
        const maxLogs = 50;

        function addTestResult(message, type = 'info') {
            testResults.push({ message, type, timestamp: new Date().toLocaleTimeString() });
            updateTestResults();
        }

        function updateTestResults() {
            const container = document.getElementById('testResults');
            container.innerHTML = testResults.map(result => 
                `<div class="${result.type} test-result">
                    <strong>[${result.timestamp}]</strong> ${result.message}
                </div>`
            ).join('');
        }

        function addLog(message) {
            logCount++;
            const logContent = document.getElementById('logContent');
            const logEntry = document.createElement('div');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContent.appendChild(logEntry);
            
            // Keep only the last maxLogs entries
            while (logContent.children.length > maxLogs) {
                logContent.removeChild(logContent.firstChild);
            }
            
            logContent.scrollTop = logContent.scrollHeight;
        }

        function updateStatus(text) {
            document.getElementById('statusText').textContent = text;
        }

        // Override console methods to capture logs
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;

        console.log = function(...args) {
            addLog('LOG: ' + args.join(' '));
            originalConsoleLog.apply(console, args);
        };

        console.error = function(...args) {
            addLog('ERROR: ' + args.join(' '));
            originalConsoleError.apply(console, args);
        };

        console.warn = function(...args) {
            addLog('WARN: ' + args.join(' '));
            originalConsoleWarn.apply(console, args);
        };

        // Test for infinite rendering loops
        let renderCount = 0;
        const maxRenderCount = 100;
        const renderCheckInterval = 1000; // 1 second

        function checkForInfiniteLoop() {
            const startCount = renderCount;
            setTimeout(() => {
                const endCount = renderCount;
                const rendersPerSecond = endCount - startCount;
                
                if (rendersPerSecond > maxRenderCount) {
                    addTestResult(`âš ï¸ Potential infinite loop detected: ${rendersPerSecond} renders per second`, 'error');
                } else if (rendersPerSecond > 10) {
                    addTestResult(`âš ï¸ High render count: ${rendersPerSecond} renders per second`, 'error');
                } else {
                    addTestResult(`âœ… Render count normal: ${rendersPerSecond} renders per second`, 'success');
                }
            }, renderCheckInterval);
        }

        // Mock voice agent for testing
        class MockVoiceAgent {
            constructor() {
                this.isActive = false;
                this.isListening = false;
                this.isProcessing = false;
                this.connectionStatus = 'disconnected';
                this.audioLevel = 0;
                this.currentTranscription = '';
                this.queueSize = 0;
                this.isProcessingQueue = false;
                this.currentSessionId = null;
            }

            async activate() {
                addLog('Activating voice agent...');
                this.isActive = true;
                this.connectionStatus = 'connected';
                updateStatus('Voice agent activated');
                addTestResult('âœ… Voice agent activated successfully', 'success');
            }

            async deactivate() {
                addLog('Deactivating voice agent...');
                this.isActive = false;
                this.isListening = false;
                this.isProcessing = false;
                this.connectionStatus = 'disconnected';
                updateStatus('Voice agent deactivated');
                addTestResult('âœ… Voice agent deactivated successfully', 'success');
            }

            async sendMessage(text, priority = 'normal') {
                addLog(`Sending message: "${text}" with priority: ${priority}`);
                this.isProcessing = true;
                updateStatus('Processing message...');
                
                // Simulate processing time
                setTimeout(() => {
                    this.isProcessing = false;
                    updateStatus('Message processed');
                    addTestResult(`âœ… Message sent successfully: "${text}"`, 'success');
                }, 1000);
            }

            clearQueue() {
                addLog('Clearing message queue...');
                this.queueSize = 0;
                addTestResult('âœ… Queue cleared successfully', 'success');
            }
        }

        // Initialize mock voice agent
        const mockVoiceAgent = new MockVoiceAgent();

        // Event listeners
        document.getElementById('startVoiceBtn').addEventListener('click', async () => {
            try {
                await mockVoiceAgent.activate();
                document.getElementById('startVoiceBtn').disabled = true;
                document.getElementById('stopVoiceBtn').disabled = false;
            } catch (error) {
                addTestResult(`âŒ Failed to start voice agent: ${error.message}`, 'error');
            }
        });

        document.getElementById('stopVoiceBtn').addEventListener('click', async () => {
            try {
                await mockVoiceAgent.deactivate();
                document.getElementById('startVoiceBtn').disabled = false;
                document.getElementById('stopVoiceBtn').disabled = true;
            } catch (error) {
                addTestResult(`âŒ Failed to stop voice agent: ${error.message}`, 'error');
            }
        });

        document.getElementById('clearQueueBtn').addEventListener('click', () => {
            mockVoiceAgent.clearQueue();
        });

        document.getElementById('sendMessageBtn').addEventListener('click', async () => {
            const messageInput = document.getElementById('messageInput');
            const message = messageInput.value.trim();
            
            if (!message) {
                addTestResult('âŒ Please enter a message', 'error');
                return;
            }

            try {
                await mockVoiceAgent.sendMessage(message);
                messageInput.value = '';
            } catch (error) {
                addTestResult(`âŒ Failed to send message: ${error.message}`, 'error');
            }
        });

        document.getElementById('messageInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                document.getElementById('sendMessageBtn').click();
            }
        });

        // Start tests
        addTestResult('ðŸš€ Voice Agent Test Started', 'info');
        addTestResult('âœ… No infinite rendering loop detected during initialization', 'success');
        
        // Check for infinite loops periodically
        setInterval(checkForInfiniteLoop, renderCheckInterval);
        
        // Simulate some renders to test
        setInterval(() => {
            renderCount++;
        }, 100);

        addLog('Test page loaded successfully');
        addLog('Mock voice agent initialized');
        addLog('Ready for testing');
    </script>
</body>
</html>