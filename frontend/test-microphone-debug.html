<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë§ˆì´í¬ ë””ë²„ê¹… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 5px;
            font-weight: bold;
        }
        .success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .info { background: #d1ecf1; color: #0c5460; border: 1px solid #bee5eb; }
        .warning { background: #fff3cd; color: #856404; border: 1px solid #ffeaa7; }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover { background: #0056b3; }
        button:disabled { background: #6c757d; cursor: not-allowed; }
        #log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        #audioLevel {
            width: 100%;
            height: 20px;
            background: #ddd;
            border-radius: 10px;
            overflow: hidden;
        }
        #audioLevelBar {
            height: 100%;
            background: linear-gradient(to right, #4CAF50, #FFC107, #F44336);
            width: 0%;
            transition: width 0.1s;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¤ ë§ˆì´í¬ ë””ë²„ê¹… í…ŒìŠ¤íŠ¸</h1>
        <p>ìŒì„± ì¸ì‹ ë¬¸ì œë¥¼ ì§„ë‹¨í•˜ê³  í•´ê²°í•˜ê¸° ìœ„í•œ í…ŒìŠ¤íŠ¸ì…ë‹ˆë‹¤.</p>

        <div class="test-section">
            <h3>1. ë§ˆì´í¬ ê¶Œí•œ í…ŒìŠ¤íŠ¸</h3>
            <div id="mic-status"></div>
            <button onclick="testMicrophoneAccess()">ë§ˆì´í¬ ê¶Œí•œ í…ŒìŠ¤íŠ¸</button>
        </div>

        <div class="test-section">
            <h3>2. ì˜¤ë””ì˜¤ ë ˆë²¨ ëª¨ë‹ˆí„°ë§</h3>
            <div id="audio-status"></div>
            <div id="audioLevel">
                <div id="audioLevelBar"></div>
            </div>
            <p>í˜„ì¬ ì˜¤ë””ì˜¤ ë ˆë²¨: <span id="audioLevelText">0%</span></p>
            <button onclick="startAudioMonitoring()" id="start-monitor">ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
            <button onclick="stopAudioMonitoring()" id="stop-monitor" disabled>ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€</button>
        </div>

        <div class="test-section">
            <h3>3. Web Speech API í…ŒìŠ¤íŠ¸</h3>
            <div id="speech-status"></div>
            <button onclick="testWebSpeechAPI()" id="speech-btn">ìŒì„± ì¸ì‹ í…ŒìŠ¤íŠ¸</button>
            <p>ì¸ì‹ëœ í…ìŠ¤íŠ¸: <span id="recognizedText">ì—†ìŒ</span></p>
        </div>

        <div class="test-section">
            <h3>4. ElevenLabs ì—°ê²° í…ŒìŠ¤íŠ¸</h3>
            <div id="elevenlabs-status"></div>
            <button onclick="testElevenLabsConnection()" id="elevenlabs-btn">ElevenLabs ì—°ê²° í…ŒìŠ¤íŠ¸</button>
        </div>

        <div class="test-section">
            <h3>ë””ë²„ê·¸ ë¡œê·¸</h3>
            <div id="log"></div>
            <button onclick="clearLog()">ë¡œê·¸ ì§€ìš°ê¸°</button>
        </div>
    </div>

    <script type="module">
        let audioContext = null;
        let microphone = null;
        let analyser = null;
        let dataArray = null;
        let animationId = null;
        let conversation = null;

        // ë¡œê¹… í•¨ìˆ˜
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('log');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : type === 'warning' ? 'âš ï¸' : 'â„¹ï¸';
            logElement.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${type.toUpperCase()}] ${message}`);
        }

        // 1. ë§ˆì´í¬ ê¶Œí•œ í…ŒìŠ¤íŠ¸
        window.testMicrophoneAccess = async function() {
            const statusElement = document.getElementById('mic-status');
            
            try {
                statusElement.innerHTML = '<div class="info">ğŸ”„ ë§ˆì´í¬ ê¶Œí•œ ìš”ì²­ ì¤‘...</div>';
                log('ë§ˆì´í¬ ê¶Œí•œ í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        autoGainControl: true,
                        sampleRate: 44100
                    } 
                });
                
                log('âœ… ë§ˆì´í¬ ê¶Œí•œ íšë“ ì„±ê³µ', 'success');
                
                // ë§ˆì´í¬ ì •ë³´ í™•ì¸
                const audioTracks = stream.getAudioTracks();
                if (audioTracks.length > 0) {
                    const track = audioTracks[0];
                    const settings = track.getSettings();
                    log(`ë§ˆì´í¬ ì •ë³´: ${track.label}`, 'success');
                    log(`ìƒ˜í”Œë ˆì´íŠ¸: ${settings.sampleRate}Hz, ì±„ë„: ${settings.channelCount}`, 'info');
                    
                    statusElement.innerHTML = `
                        <div class="success">âœ… ë§ˆì´í¬ ê¶Œí•œ íšë“ ì„±ê³µ</div>
                        <p><strong>ë§ˆì´í¬:</strong> ${track.label}</p>
                        <p><strong>ìƒ˜í”Œë ˆì´íŠ¸:</strong> ${settings.sampleRate}Hz</p>
                        <p><strong>ì±„ë„:</strong> ${settings.channelCount}</p>
                    `;
                } else {
                    throw new Error('ì˜¤ë””ì˜¤ íŠ¸ë™ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                // ìŠ¤íŠ¸ë¦¼ ì •ë¦¬
                stream.getTracks().forEach(track => track.stop());
                
            } catch (error) {
                log(`âŒ ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜: ${error.message}`, 'error');
                statusElement.innerHTML = `<div class="error">âŒ ë§ˆì´í¬ ê¶Œí•œ ì˜¤ë¥˜: ${error.message}</div>`;
                
                if (error.name === 'NotAllowedError') {
                    statusElement.innerHTML += '<p>ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ ë§ˆì´í¬ ê¶Œí•œì„ í—ˆìš©í•´ì£¼ì„¸ìš”.</p>';
                } else if (error.name === 'NotFoundError') {
                    statusElement.innerHTML += '<p>ë§ˆì´í¬ê°€ ì—°ê²°ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.</p>';
                }
            }
        };

        // 2. ì˜¤ë””ì˜¤ ë ˆë²¨ ëª¨ë‹ˆí„°ë§
        window.startAudioMonitoring = async function() {
            const statusElement = document.getElementById('audio-status');
            const startBtn = document.getElementById('start-monitor');
            const stopBtn = document.getElementById('stop-monitor');
            
            try {
                statusElement.innerHTML = '<div class="info">ğŸ”„ ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì‹œì‘ ì¤‘...</div>';
                log('ì˜¤ë””ì˜¤ ë ˆë²¨ ëª¨ë‹ˆí„°ë§ ì‹œì‘');
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: false, // ë””ë²„ê¹…ì„ ìœ„í•´ ë„ê¸°
                        noiseSuppression: false,
                        autoGainControl: false
                    } 
                });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                microphone = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                
                analyser.fftSize = 256;
                const bufferLength = analyser.frequencyBinCount;
                dataArray = new Uint8Array(bufferLength);
                
                microphone.connect(analyser);
                
                function updateAudioLevel() {
                    analyser.getByteFrequencyData(dataArray);
                    
                    let sum = 0;
                    for (let i = 0; i < bufferLength; i++) {
                        sum += dataArray[i];
                    }
                    const average = sum / bufferLength;
                    const percentage = Math.round((average / 255) * 100);
                    
                    document.getElementById('audioLevelBar').style.width = percentage + '%';
                    document.getElementById('audioLevelText').textContent = percentage + '%';
                    
                    if (percentage > 5) {
                        log(`ì˜¤ë””ì˜¤ ê°ì§€: ${percentage}%`, 'success');
                    }
                    
                    animationId = requestAnimationFrame(updateAudioLevel);
                }
                
                updateAudioLevel();
                
                statusElement.innerHTML = '<div class="success">âœ… ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ í™œì„±í™”</div>';
                startBtn.disabled = true;
                stopBtn.disabled = false;
                log('âœ… ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ í™œì„±í™”ë¨', 'success');
                
            } catch (error) {
                log(`âŒ ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: ${error.message}`, 'error');
                statusElement.innerHTML = `<div class="error">âŒ ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };

        window.stopAudioMonitoring = function() {
            if (animationId) {
                cancelAnimationFrame(animationId);
                animationId = null;
            }
            
            if (audioContext) {
                audioContext.close();
                audioContext = null;
            }
            
            document.getElementById('audioLevelBar').style.width = '0%';
            document.getElementById('audioLevelText').textContent = '0%';
            document.getElementById('audio-status').innerHTML = '<div class="info">ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨</div>';
            document.getElementById('start-monitor').disabled = false;
            document.getElementById('stop-monitor').disabled = true;
            
            log('ì˜¤ë””ì˜¤ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€ë¨', 'info');
        };

        // 3. Web Speech API í…ŒìŠ¤íŠ¸
        window.testWebSpeechAPI = function() {
            const statusElement = document.getElementById('speech-status');
            const recognizedElement = document.getElementById('recognizedText');
            
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                statusElement.innerHTML = '<div class="error">âŒ Web Speech APIê°€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤</div>';
                log('âŒ Web Speech API ì§€ì›ë˜ì§€ ì•ŠìŒ', 'error');
                return;
            }
            
            try {
                statusElement.innerHTML = '<div class="info">ğŸ”„ ìŒì„± ì¸ì‹ ì‹œì‘ ì¤‘...</div>';
                log('Web Speech API í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                const SpeechRecognition = window.webkitSpeechRecognition || window.SpeechRecognition;
                const recognition = new SpeechRecognition();
                
                recognition.continuous = false;
                recognition.interimResults = true;
                recognition.lang = 'ko-KR'; // í•œêµ­ì–´ë¡œ ì„¤ì •
                
                recognition.onstart = () => {
                    statusElement.innerHTML = '<div class="success">âœ… ìŒì„± ì¸ì‹ í™œì„±í™” - ë§ì”€í•´ì£¼ì„¸ìš”!</div>';
                    log('âœ… Web Speech API ìŒì„± ì¸ì‹ ì‹œì‘ë¨', 'success');
                };
                
                recognition.onresult = (event) => {
                    let transcript = '';
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        transcript += event.results[i][0].transcript;
                    }
                    
                    recognizedElement.textContent = transcript;
                    log(`ìŒì„± ì¸ì‹ ê²°ê³¼: "${transcript}" (ì‹ ë¢°ë„: ${Math.round(event.results[0][0].confidence * 100)}%)`, 'success');
                };
                
                recognition.onerror = (event) => {
                    log(`âŒ Web Speech API ì˜¤ë¥˜: ${event.error}`, 'error');
                    statusElement.innerHTML = `<div class="error">âŒ ìŒì„± ì¸ì‹ ì˜¤ë¥˜: ${event.error}</div>`;
                };
                
                recognition.onend = () => {
                    statusElement.innerHTML = '<div class="info">ìŒì„± ì¸ì‹ ì¢…ë£Œë¨</div>';
                    log('Web Speech API ìŒì„± ì¸ì‹ ì¢…ë£Œë¨', 'info');
                };
                
                recognition.start();
                
            } catch (error) {
                log(`âŒ Web Speech API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                statusElement.innerHTML = `<div class="error">âŒ Web Speech API í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };

        // 4. ElevenLabs ì—°ê²° í…ŒìŠ¤íŠ¸
        window.testElevenLabsConnection = async function() {
            const statusElement = document.getElementById('elevenlabs-status');
            
            try {
                statusElement.innerHTML = '<div class="info">ğŸ”„ ElevenLabs ì—°ê²° í…ŒìŠ¤íŠ¸ ì¤‘...</div>';
                log('ElevenLabs ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹œì‘');
                
                const agentId = import.meta.env.VITE_ELEVENLABS_AGENT_ID;
                if (!agentId) {
                    throw new Error('ElevenLabs Agent IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤');
                }
                
                log(`Agent ID: ${agentId}`);
                
                // ElevenLabs ë¼ì´ë¸ŒëŸ¬ë¦¬ import
                const { Conversation } = await import('@elevenlabs/client');
                log('âœ… ElevenLabs ë¼ì´ë¸ŒëŸ¬ë¦¬ ë¡œë“œ ì„±ê³µ', 'success');
                
                // ë§ˆì´í¬ ê¶Œí•œ ë¨¼ì € ìš”ì²­
                await navigator.mediaDevices.getUserMedia({ audio: true });
                log('âœ… ë§ˆì´í¬ ê¶Œí•œ í™•ì¸ë¨', 'success');
                
                // ElevenLabs ëŒ€í™” ì„¸ì…˜ ìƒì„±
                conversation = await Conversation.startSession({
                    agentId: agentId,
                    connectionType: 'webrtc',
                    onConnect: () => {
                        log('âœ… ElevenLabs ì—°ê²° ì„±ê³µ', 'success');
                        statusElement.innerHTML = '<div class="success">âœ… ElevenLabs ì—°ê²° ì„±ê³µ</div>';
                    },
                    onDisconnect: () => {
                        log('ElevenLabs ì—°ê²° í•´ì œë¨', 'warning');
                    },
                    onError: (error) => {
                        log(`âŒ ElevenLabs ì˜¤ë¥˜: ${error.message || error}`, 'error');
                        statusElement.innerHTML = `<div class="error">âŒ ElevenLabs ì˜¤ë¥˜: ${error.message || error}</div>`;
                    },
                    onMessage: (message) => {
                        log(`ElevenLabs ë©”ì‹œì§€: ${JSON.stringify(message)}`, 'info');
                        
                        // ë¹ˆ ë©”ì‹œì§€ ê°ì§€
                        if (message.source === 'user' && (message.message === '...' || !message.message.trim())) {
                            log('âš ï¸ ë¹ˆ ì‚¬ìš©ì ë©”ì‹œì§€ ê°ì§€ë¨ - ìŒì„± ì¸ì‹ ë¬¸ì œ ê°€ëŠ¥ì„±', 'warning');
                            statusElement.innerHTML += '<div class="warning">âš ï¸ ë¹ˆ ë©”ì‹œì§€ ê°ì§€ - ë§ˆì´í¬ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”</div>';
                        }
                    },
                    onModeChange: (mode) => {
                        log(`ElevenLabs ëª¨ë“œ ë³€ê²½: ${JSON.stringify(mode)}`, 'info');
                    }
                });
                
                log(`âœ… ElevenLabs ëŒ€í™” ì„¸ì…˜ ìƒì„±ë¨: ${conversation.getId()}`, 'success');
                
            } catch (error) {
                log(`âŒ ElevenLabs ì—°ê²° í…ŒìŠ¤íŠ¸ ì˜¤ë¥˜: ${error.message}`, 'error');
                statusElement.innerHTML = `<div class="error">âŒ ElevenLabs ì—°ê²° ì˜¤ë¥˜: ${error.message}</div>`;
            }
        };

        // ë¡œê·¸ ì§€ìš°ê¸°
        window.clearLog = function() {
            document.getElementById('log').textContent = '';
        };

        // ì´ˆê¸°í™”
        log('ğŸ¤ ë§ˆì´í¬ ë””ë²„ê¹… í…ŒìŠ¤íŠ¸ ì´ˆê¸°í™”ë¨');
        log('1. ë¨¼ì € ë§ˆì´í¬ ê¶Œí•œì„ í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”');
        log('2. ì˜¤ë””ì˜¤ ë ˆë²¨ ëª¨ë‹ˆí„°ë§ìœ¼ë¡œ ë§ˆì´í¬ê°€ ì†Œë¦¬ë¥¼ ê°ì§€í•˜ëŠ”ì§€ í™•ì¸í•´ì£¼ì„¸ìš”');
        log('3. Web Speech APIë¡œ ìŒì„± ì¸ì‹ì´ ì‘ë™í•˜ëŠ”ì§€ í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”');
        log('4. ElevenLabs ì—°ê²°ì„ í…ŒìŠ¤íŠ¸í•´ì£¼ì„¸ìš”');
    </script>
</body>
</html>